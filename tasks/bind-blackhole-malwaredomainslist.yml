---

- name: add blockedomain settings for mdl
  template:
    src: blockeddomain.hosts.j2
    dest: "{{ bind_etc }}/blockeddomain.hosts"
    mode: 0644

- name: add malware domains list zone in local configuration
  blockinfile:
    dest: "{{ bind_etc }}/named.conf.local"
    marker: '// {mark} ANSIBLE MANAGED BLOCK: malware domains list'
    block: |
       include "{{ bind_etc }}/spywaredomains.zones";
  notify:
    - restart bind

- name: install update script
  template:
    src: bind-mdl-update.sh.j2
    dest: /usr/local/bin/bind-mdl-update.sh
    mode: 0755

- name: Check if dns resolution works as expected
  shell: "{{ item }}"
  with_items:
    - host malware-domains.com
    - ps axu |grep bind
  changed_when: false
  ignore_errors: true
  register: d
- debug: var=d

- name: recover first list
  command: "/usr/local/bin/bind-mdl-update.sh creates={{ bind_etc }}/spywaredomains.zones"
  notify:
    - restart bind

- name: redhat | disable zone check because of minor errors in mdl file
  lineinfile:
    dest: /etc/sysconfig/named
    regexp: '^DISABLE_ZONE_CHECKING=.*'
    line: 'DISABLE_ZONE_CHECKING=yes'
    backup: yes
  when: ansible_os_family == 'RedHat'
